name: CI

on:
  push:
    branches: [main, stage]
  pull_request:
    branches: [main, stage]

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 16.x

      - name: Install
        run: yarn

      - name: Run tests
        run: yarn run jest --coverage --ci --json --outputFile=test-results.json

      - name: ESLint + Prettier
        run: yarn lint

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          name: 2022-1-MeasureSoftGram-Front
          verbose: true
          # directory: ./
          # # env_vars: OS,PYTHON
          # fail_ci_if_error: true
          # files: ./coverage.json
          # flags: unittests

      - name: SonarCloud Scan
        if: always()
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Criar diretório
        run: mkdir analytics-raw-data

      - name: Coletar métricas no SonarCloud
        run: python parser.py ${{ github.event.repository.name }} ${{ github.ref_name }}

      - name: Adiciona resultado das métricas
        uses: actions/upload-artifact@v3
        with:
          name: metrics_results
          path: ./analytics-raw-data/*

      - name: Envia métricas para repo de Doc
        run: |
          git config --global user.email "${{secrets.USER_EMAIL}}"
          git config --global user.name "${{secrets.USER_NAME}}"
          git clone --single-branch --branch main "https://x-access-token:${{secrets.API_TOKEN_DOC_REPOSITORY}}@github.com/fga-eps-mds/2022-1-MeasureSoftGram-Doc" doc_repo
          mkdir -p doc_repo/analytics-raw-data
          cp -R analytics-raw-data/*.json doc_repo/analytics-raw-data
          cd doc_repo
          git add .
          git commit -m "Adds metric file from ${{ github.event.repository.name }} ${{ github.ref_name }}"
          git push
